{"version":3,"file":"webmeeting.min.js","sources":["../src/webmeeting.js"],"sourcesContent":["// This file is part of the Zoom plugin for Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Toggles text to be shown when a user hits 'Show More' and\n * hides text when user hits 'Show Less'\n *\n * @copyright  2020 UC Regents, 2023 Giorgio Consorti\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n(function () {\n\n\n  const init = (zoomObj, userObj, zoomMeetingSdkWebVersion, debugging) => {\n\n    const debug = debugging || false;\n\n    const decodeEntity = (inputStr) => {\n      var textarea = document.createElement('textarea');\n      textarea.innerHTML = inputStr;\n      return textarea.value;\n    };\n\n    const log = function () {\n      if (debug) {\n        const LOG_PREFIX = () => \"**** LYNX **** \" + new Date().toLocaleString() + \": \";\n        var args = Array.from(arguments);\n        args.unshift(LOG_PREFIX());\n        window.console.log.apply(window.console, args);\n      }\n    };\n\n    const error = function () {\n      if (debug) {\n        const LOG_PREFIX = () => \"**** LYNX **** \" + new Date().toLocaleString() + \": \";\n        var args = Array.from(arguments);\n        args.unshift(LOG_PREFIX());\n        window.console.error.apply(window.console, args);\n      }\n    };\n\n    const startMeeting = () => {\n\n      document.getElementById('zmmtg-root').style.display = 'block';\n\n      log('init meeting with zoom object', zoomObj);\n      log('init meeting with user object', userObj);\n      log('Meeting SDK', window.ZoomMtg.getWebSDKVersion());\n      log('checkFeatureRequirements', window.ZoomMtg.checkFeatureRequirements());\n\n      window.ZoomMtg.init({\n        // see: https://marketplacefront.zoom.us/sdk/meeting/web/modules.html#initArgs\n        // and  https://marketplacefront.zoom.us/sdk/meeting/web/components/index.html\n        leaveUrl: decodeEntity(zoomObj.leaveUrl),\n        debug: debug,\n        disableCORP: !window.crossOriginIsolated,\n        enableHD: true,\n        enableFullHD: true,\n        isSupportAV: true,\n        showMeetingHeader: zoomObj.userishost,\n        // disableVoIP: true,\n        videoHeader: zoomObj.userishost,\n        isSupportBreakout: false,\n        isSupportCC: zoomObj.userishost,\n        isSupportChat: zoomObj.userishost,\n        isSupportNonverbal: zoomObj.userishost,\n        isSupportPolling: zoomObj.userishost,\n        isSupportQA: zoomObj.userishost,\n        // isLockBottom: true,\n        disableCallOut: !zoomObj.userishost,\n        disableInvite: !zoomObj.userishost,\n        // disablePreview: true,\n        disableRecord: !zoomObj.userishost,\n        disableReport: !zoomObj.userishost,\n        meetingInfo: (zoomObj.userishost ? [\n          'topic',\n          'host',\n          'participant',\n          'mn', // meeting number\n          'dc',\n          'pwd',\n          // 'telPwd',\n          'invite',\n          'enctype',\n          // 'report',\n        ] : []),\n        success: function (initResp) {\n          log(\"intResponse is \", initResp);\n          window.ZoomMtg.join({\n            signature: zoomObj.signature,\n            sdkKey: zoomObj.sdkKey,\n            meetingNumber: zoomObj.meeting_id,\n            userName: userObj.fullname,\n            userEmail: userObj.email,\n            // password optional; set by Host\n            passWord: zoomObj.password,\n            // tk: registrantToken,\n            // zak: zakToken\n            success: function (joinResp) {\n              if (!zoomObj.userishost) {\n                Array.from(document.getElementsByClassName('meeting-info-container--left-side') ?? []).forEach((element) => {\n                  element.style.display = 'none';\n                });\n              }\n              addZoomSessionKeys();\n              log(\"joinResp is \", joinResp);\n            },\n            error: function (joinResp) {\n              error(\"joinResp is \", joinResp);\n            }\n          });\n        },\n        error: (initResp) => {\n          error(\"intResponse is \", initResp);\n        }\n      });\n    };\n\n    const addZoomSessionKeys = () => {\n      const addedKeys = getNewSessionKeys(sessionKeys);\n      log(\"sessionStorage items added by zoom\", addedKeys);\n      if (addedKeys.length) {\n        const zoomKeys = (window.sessionStorage.getItem('zoomKeys') ?? '').split(',').filter(el => el.length > 0);\n        addedKeys.forEach((key) => {\n          if (!zoomKeys.includes(key)) {\n            zoomKeys.push(key);\n          }\n        });\n        if (zoomKeys.length > 0) {\n          log('storing zoomKeys', zoomKeys);\n          window.sessionStorage.setItem('zoomKeys', zoomKeys.join(','));\n        } else {\n          log('removing zoomKeys since it was an empty array');\n          window.sessionStorage.removeItem('zoomKeys');\n        }\n      }\n    };\n\n    const getSessionKeys = () => {\n      let retval = [];\n      Object.keys(window.sessionStorage).forEach((key) => retval.push(key));\n      return retval;\n    };\n\n    const getNewSessionKeys = (startArr) => getSessionKeys().filter(x => !startArr.includes(x));\n\n    log('**********************************************');\n\n    /**\n     * get keys stored in sessionStorage.\n     * The init/success callback will add a new session key\n     * called 'zoomKeys' containig only the keys added by zoom.\n     *\n     * When the user logs out from moodle, the zoom_handler::loggedout\n     * php method will take care of deleting them, actually logging out\n     * the user from zoom.\n     */\n    const sessionKeys = getSessionKeys();\n\n    let language = userObj.lang || 'en-US';\n    if (-1 === language.indexOf('-')) {\n      language = language.toLowerCase() + '-' + (language !== 'en' ? language.toUpperCase() : 'US');\n    }\n\n    /**\n     * WARNING!!!\n     * Don't you dare removing https and starting the url with '//'.\n     * The lib is not going to work!\n     */\n    window.ZoomMtg.setZoomJSLib(`https://source.zoom.us/${zoomMeetingSdkWebVersion}/lib`, '/av');\n    window.ZoomMtg.preLoadWasm();\n\n    if ('function' == typeof window.ZoomMtg.prepareWebSDK) {\n      window.ZoomMtg.prepareWebSDK();\n    } else {\n      window.ZoomMtg.prepareJssdk();\n    }\n    // // loads language files, also passes any error messages to the ui\n    window.ZoomMtg.i18n.load(language);\n    window.ZoomMtg.i18n.reload(language);\n    // window.ZoomMtg.reRender({ lang: language });\n\n    startMeeting();\n\n    log('**********************************************');\n  };\n\n  // add event listeners\n  window.addEventListener(\"message\", (event) => {\n    if (window.self !== window.top) {\n      // messages handled inside the iframe\n      if (event.data.message === 'init') {\n        // trigger the init function\n        init(event.data.zoom, event.data.user, event.data.zoomSdkVersion, event.data.debugging);\n      }\n    } else {\n      // messages outside the iframe (i.e. in webmeeting.php)\n      if (event.data.message === 'zoomLeave') {\n        // zoomLeave, redirect to passed url\n        if ('redirect' in event.data) {\n          window.location.replace(event.data.redirect);\n        }\n      }\n    }\n  }, false);\n\n})();\n"],"names":["window","addEventListener","event","self","top","data","message","zoomObj","userObj","zoomMeetingSdkWebVersion","debugging","debug","log","LOG_PREFIX","Date","toLocaleString","args","Array","from","arguments","unshift","console","apply","error","addZoomSessionKeys","addedKeys","getNewSessionKeys","sessionKeys","length","zoomKeys","sessionStorage","getItem","split","filter","el","forEach","key","includes","push","setItem","join","removeItem","getSessionKeys","retval","Object","keys","startArr","x","language","lang","inputStr","textarea","indexOf","toLowerCase","toUpperCase","ZoomMtg","setZoomJSLib","preLoadWasm","prepareWebSDK","prepareJssdk","i18n","load","reload","document","getElementById","style","display","getWebSDKVersion","checkFeatureRequirements","init","leaveUrl","createElement","innerHTML","value","disableCORP","crossOriginIsolated","enableHD","enableFullHD","isSupportAV","showMeetingHeader","userishost","videoHeader","isSupportBreakout","isSupportCC","isSupportChat","isSupportNonverbal","isSupportPolling","isSupportQA","disableCallOut","disableInvite","disableRecord","disableReport","meetingInfo","success","initResp","signature","sdkKey","meetingNumber","meeting_id","userName","fullname","userEmail","email","passWord","password","joinResp","getElementsByClassName","element","zoom","user","zoomSdkVersion","location","replace","redirect"],"mappings":"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"}