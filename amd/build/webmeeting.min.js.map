{"version":3,"file":"webmeeting.min.js","sources":["../src/webmeeting.js"],"sourcesContent":["// This file is part of the Zoom plugin for Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Toggles text to be shown when a user hits 'Show More' and\n * hides text when user hits 'Show Less'\n *\n * @copyright  2020 UC Regents, 2023 Giorgio Consorti\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n(function () {\n\n\n  const init = (zoomObj, userObj, zoomMeetingSdkWebVersion, debugging) => {\n\n    const debug = debugging || false;\n\n    const decodeEntity = (inputStr) => {\n      var textarea = document.createElement('textarea');\n      textarea.innerHTML = inputStr;\n      return textarea.value;\n    };\n\n    const log = function () {\n      if (debug) {\n        const LOG_PREFIX = () => \"**** LYNX **** \" + new Date().toLocaleString() + \": \";\n        var args = Array.from(arguments);\n        args.unshift(LOG_PREFIX());\n        window.console.log.apply(window.console, args);\n      }\n    };\n\n    const error = function () {\n      if (debug) {\n        const LOG_PREFIX = () => \"**** LYNX **** \" + new Date().toLocaleString() + \": \";\n        var args = Array.from(arguments);\n        args.unshift(LOG_PREFIX());\n        window.console.error.apply(window.console, args);\n      }\n    };\n\n    const initCallBack = function (isError, response) {\n\n      window.parent.postMessage({\n        message: \"zoomInitDone\",\n        userishost: zoomObj.userishost,\n        debugging: debug,\n      });\n\n      if (!isError) {\n        log(\"intResponse is \", response);\n        window.ZoomMtg.join({\n          signature: zoomObj.signature,\n          sdkKey: zoomObj.sdkKey,\n          meetingNumber: zoomObj.meeting_id,\n          userName: userObj.fullname,\n          userEmail: userObj.email,\n          // password optional; set by Host\n          passWord: zoomObj.password,\n          tk: zoomObj.tk,\n          zak: zoomObj.zak,\n          success: function (joinResp) {\n            if (!zoomObj.userishost) {\n              // leave recording indication only, for privacy issues\n              Array.from(document.getElementsByClassName('meeting-info-container--left-side') ?? []).forEach(\n                (el) => {\n                  Array.from(el.childNodes).filter(\n                    (child) => !child.classList.contains('recording-indication__recording-container')\n                  ).forEach(\n                    (el) => { el.style.display = 'none'; }\n                  );\n                }\n              );\n              // Remove screen sharing, Captions and Reaction buttons for non-host\n              Array.from(document.querySelectorAll(\n                '[feature-type=\"sharing\"], [feature-type=\"newLTT\"], [feature-type=\"reaction\"]') ?? []\n              ).forEach(\n                (el) => {\n                  el.remove();\n                }\n              );\n            }\n            window.parent.postMessage({\n              message: \"zoomJoined\",\n              userishost: zoomObj.userishost,\n              debugging: debug,\n            });\n            addZoomSessionKeys();\n            log(\"joinResp is \", joinResp);\n          },\n          error: function (joinResp) {\n            error(\"joinResp is \", joinResp);\n          }\n        });\n      } else {\n        error(\"intResponse is \", response);\n      }\n    };\n\n    const startMeeting = () => {\n\n      document.getElementById('zmmtg-root').style.display = 'block';\n\n      log('init meeting with zoom object', zoomObj);\n      log('init meeting with user object', userObj);\n      log('Meeting SDK', window.ZoomMtg.getWebSDKVersion());\n      log('checkFeatureRequirements', window.ZoomMtg.checkFeatureRequirements());\n\n      window.ZoomMtg.init({\n        // see: https://marketplacefront.zoom.us/sdk/meeting/web/modules.html#initArgs\n        // and  https://marketplacefront.zoom.us/sdk/meeting/web/components/index.html\n        leaveUrl: decodeEntity(zoomObj.leaveUrl),\n        debug: debug,\n        disableCORP: !window.crossOriginIsolated,\n        enableHD: true,\n        enableFullHD: true,\n        isSupportAV: true,\n        showMeetingHeader: zoomObj.userishost,\n        // disableVoIP: true,\n        videoHeader: zoomObj.userishost,\n        isSupportBreakout: zoomObj.userishost,\n        isSupportCC: false, // zoomObj.userishost,\n        isSupportChat: true,\n        isSupportNonverbal: zoomObj.userishost,\n        isSupportPolling: zoomObj.userishost,\n        isSupportQA: zoomObj.userishost,\n        // isLockBottom: true,\n        disableCallOut: !zoomObj.userishost,\n        disableInvite: !zoomObj.userishost,\n        // disablePreview: true,\n        disableRecord: !zoomObj.userishost,\n        disableReport: !zoomObj.userishost,\n        screenShare: zoomObj.userishost,\n        meetingInfo: (zoomObj.userishost ? [\n          'topic',\n          'host',\n          'participant',\n          'mn', // meeting number\n          'dc',\n          'pwd',\n          // 'telPwd',\n          'invite',\n          'enctype',\n          // 'report',\n        ] : []),\n        success: function (initResp) {\n          initCallBack(false, initResp);\n        },\n        error: (initResp) => {\n          initCallBack(true, initResp);\n        }\n      });\n    };\n\n    const addZoomSessionKeys = () => {\n      const addedKeys = getNewSessionKeys(sessionKeys);\n      log(\"sessionStorage items added by zoom\", addedKeys);\n      if (addedKeys.length) {\n        const zoomKeys = (window.sessionStorage.getItem('zoomKeys') ?? '').split(',').filter(el => el.length > 0);\n        addedKeys.forEach((key) => {\n          if (!zoomKeys.includes(key)) {\n            zoomKeys.push(key);\n          }\n        });\n        if (zoomKeys.length > 0) {\n          log('storing zoomKeys', zoomKeys);\n          window.sessionStorage.setItem('zoomKeys', zoomKeys.join(','));\n        } else {\n          log('removing zoomKeys since it was an empty array');\n          window.sessionStorage.removeItem('zoomKeys');\n        }\n      }\n    };\n\n    const getSessionKeys = () => {\n      let retval = [];\n      Object.keys(window.sessionStorage).forEach((key) => retval.push(key));\n      return retval;\n    };\n\n    const getNewSessionKeys = (startArr) => getSessionKeys().filter(x => !startArr.includes(x));\n\n    log('**********************************************');\n\n    /**\n     * get keys stored in sessionStorage.\n     * The init/success callback will add a new session key\n     * called 'zoomKeys' containig only the keys added by zoom.\n     *\n     * When the user logs out from moodle, the zoom_handler::loggedout\n     * php method will take care of deleting them, actually logging out\n     * the user from zoom.\n     */\n    const sessionKeys = getSessionKeys();\n\n    let language = userObj.lang || 'en-US';\n    if (-1 === language.indexOf('-')) {\n      language = language.toLowerCase() + '-' + (language !== 'en' ? language.toUpperCase() : 'US');\n    }\n\n    /**\n     * WARNING!!!\n     * Don't you dare removing https and starting the url with '//'.\n     * The lib is not going to work!\n     */\n    window.ZoomMtg.setZoomJSLib(`https://source.zoom.us/${zoomMeetingSdkWebVersion}/lib`, '/av');\n    window.ZoomMtg.preLoadWasm();\n\n    if ('function' == typeof window.ZoomMtg.prepareWebSDK) {\n      window.ZoomMtg.prepareWebSDK();\n    } else {\n      window.ZoomMtg.prepareJssdk();\n    }\n    // // loads language files, also passes any error messages to the ui\n    window.ZoomMtg.i18n.load(language);\n    window.ZoomMtg.i18n.reload(language);\n    // window.ZoomMtg.reRender({ lang: language });\n\n    startMeeting();\n\n    log('**********************************************');\n  };\n\n  // add event listeners\n  if (window.self == window.top) {\n    /**\n     * add event listener for the main page, i.e. outside the iframe\n     */\n    window.addEventListener(\"message\", (event) => {\n      const meetingEl = document.getElementById('meetingSDKElement');\n      if (event.data.message === 'zoomLeave') {\n        // zoomLeave, redirect to passed url\n        if ('zoomLeave' in event.data) {\n          if ('debugging' in event.data && event.data.debugging && 'userishost' in event.data && event.data.userishost) {\n            // replace the iframe with a back link.\n            // const iframeParent = document.getElementById('meetingSDKElement').parentNode;\n            // iframeParent.style.margin = \"0\";\n            // iframeParent.style.padding = \"0\";\n            if (meetingEl && meetingEl.parentNode) {\n              meetingEl.parentNode.classList.remove(...meetingEl.parentNode.classList);\n              meetingEl.parentNode.innerHTML = `<a href=\"${event.data.zoomLeave}\">${event.data.zoomLeave}</a>`;\n            }\n          } else {\n            window.location.replace(event.data.zoomLeave);\n          }\n        }\n      } else if (event.data.message === 'zoomInitDone') {\n        if (meetingEl) {\n          if (!('debugging' in event.data && event.data.debugging)) {\n            meetingEl.removeAttribute('onload');\n          }\n        }\n      } else if (event.data.message === 'zoomJoined') {\n        if (meetingEl) {\n          meetingEl.parentNode.classList.add('embed-responsive', 'embed-responsive-16by9', 'joined');\n        }\n      }\n    }, false);\n  } else {\n    /**\n     * add event listener for the zoom meeting, i.e. inside the iframe\n     */\n    window.addEventListener(\"message\", (event) => {\n      // messages handled inside the iframe\n      if (event.data.message === 'init') {\n        // trigger the init function\n        init(event.data.zoom, event.data.user, event.data.zoomSdkVersion, event.data.debugging);\n      }\n    }, false);\n  }\n\n})();\n"],"names":["window","self","top","addEventListener","event","meetingEl","document","getElementById","data","message","debugging","userishost","parentNode","classList","remove","innerHTML","zoomLeave","location","replace","removeAttribute","add","init","zoomObj","userObj","zoomMeetingSdkWebVersion","debug","log","LOG_PREFIX","Date","toLocaleString","args","Array","from","arguments","unshift","console","apply","error","initCallBack","isError","response","parent","postMessage","ZoomMtg","join","signature","sdkKey","meetingNumber","meeting_id","userName","fullname","userEmail","email","passWord","password","tk","zak","success","joinResp","getElementsByClassName","forEach","el","childNodes","filter","child","contains","style","display","querySelectorAll","addZoomSessionKeys","addedKeys","getNewSessionKeys","sessionKeys","length","zoomKeys","sessionStorage","getItem","split","key","includes","push","setItem","removeItem","getSessionKeys","retval","Object","keys","startArr","x","language","lang","startMeeting","inputStr","textarea","indexOf","toLowerCase","toUpperCase","setZoomJSLib","preLoadWasm","prepareWebSDK","prepareJssdk","i18n","load","reload","getWebSDKVersion","checkFeatureRequirements","leaveUrl","createElement","value","disableCORP","crossOriginIsolated","enableHD","enableFullHD","isSupportAV","showMeetingHeader","videoHeader","isSupportBreakout","isSupportCC","isSupportChat","isSupportNonverbal","isSupportPolling","isSupportQA","disableCallOut","disableInvite","disableRecord","disableReport","screenShare","meetingInfo","initResp","zoom","user","zoomSdkVersion"],"mappings":"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"}