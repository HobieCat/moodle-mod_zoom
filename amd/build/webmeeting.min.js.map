{"version":3,"file":"webmeeting.min.js","sources":["../src/webmeeting.js"],"sourcesContent":["// This file is part of the Zoom plugin for Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Toggles text to be shown when a user hits 'Show More' and\n * hides text when user hits 'Show Less'\n *\n * @copyright  2020 UC Regents, 2023 Giorgio Consorti\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n(function () {\n\n\n  const init = (zoomObj, userObj, zoomMeetingSdkWebVersion, debugging) => {\n\n    const debug = debugging || false;\n\n    const decodeEntity = (inputStr) => {\n      var textarea = document.createElement('textarea');\n      textarea.innerHTML = inputStr;\n      return textarea.value;\n    };\n\n    const log = function () {\n      if (debug) {\n        const LOG_PREFIX = () => \"**** LYNX **** \" + new Date().toLocaleString() + \": \";\n        var args = Array.from(arguments);\n        args.unshift(LOG_PREFIX());\n        window.console.log.apply(window.console, args);\n      }\n    };\n\n    const error = function () {\n      if (debug) {\n        const LOG_PREFIX = () => \"**** LYNX **** \" + new Date().toLocaleString() + \": \";\n        var args = Array.from(arguments);\n        args.unshift(LOG_PREFIX());\n        window.console.error.apply(window.console, args);\n      }\n    };\n\n    const startMeeting = () => {\n\n      document.getElementById('zmmtg-root').style.display = 'block';\n\n      log('init meeting with zoom object', zoomObj);\n      log('init meeting with user object', userObj);\n      log('Meeting SDK', window.ZoomMtg.getWebSDKVersion());\n      log(window.ZoomMtg.checkFeatureRequirements());\n\n      window.ZoomMtg.init({\n        // see: https://marketplacefront.zoom.us/sdk/meeting/web/modules.html#initArgs\n        // and  https://marketplacefront.zoom.us/sdk/meeting/web/components/index.html\n        leaveUrl: decodeEntity(zoomObj.leaveUrl),\n        debug: debug,\n        disableCORP: !window.crossOriginIsolated,\n        enableHD: true,\n        enableFullHD: true,\n        isSupportAV: true,\n        showMeetingHeader: zoomObj.userishost,\n        // disableVoIP: true,\n        videoHeader: zoomObj.userishost,\n        isSupportBreakout: false,\n        isSupportCC: zoomObj.userishost,\n        isSupportChat: zoomObj.userishost,\n        isSupportNonverbal: zoomObj.userishost,\n        isSupportPolling: zoomObj.userishost,\n        isSupportQA: zoomObj.userishost,\n        // isLockBottom: true,\n        disableCallOut: !zoomObj.userishost,\n        disableInvite: !zoomObj.userishost,\n        // disablePreview: true,\n        disableRecord: !zoomObj.userishost,\n        disableReport: !zoomObj.userishost,\n        meetingInfo: (zoomObj.userishost ? [\n          'topic',\n          'host',\n          'participant',\n          'mn', // meeting number\n          'dc',\n          'pwd',\n          // 'telPwd',\n          'invite',\n          'enctype',\n          // 'report',\n        ] : []),\n        success: function (initResp) {\n          log(\"intResponse is \", initResp);\n          window.ZoomMtg.join({\n            signature: zoomObj.signature,\n            sdkKey: zoomObj.sdkKey,\n            meetingNumber: zoomObj.meeting_id,\n            userName: userObj.fullname,\n            userEmail: userObj.email,\n            // password optional; set by Host\n            passWord: zoomObj.password,\n            // tk: registrantToken,\n            // zak: zakToken\n            success: function (joinResp) {\n              if (!zoomObj.userishost) {\n                Array.from(document.getElementsByClassName('meeting-info-container--left-side') ?? []).forEach((element) => {\n                  element.style.display = 'none';\n                });\n              }\n              const addedKeys = getNewSessionKeys(sessionKeys);\n              if (addedKeys.length) {\n                window.sessionStorage.setItem('zoomKeys', addedKeys.join(','));\n              }\n              log(\"joinResp is \", joinResp);\n            },\n            error: function (joinResp) {\n              error(\"joinResp is \", joinResp);\n            }\n          });\n        },\n        error: (initResp) => {\n          error(\"intResponse is \", initResp);\n        }\n      });\n    };\n\n    const getSessionKeys = () => {\n      let retval = [];\n      Object.keys(window.sessionStorage).forEach(function (key) {\n        retval.push(key);\n      });\n      return retval;\n    };\n\n    const getNewSessionKeys = (startArr) => {\n      let newKeys = getSessionKeys();\n      return newKeys.filter(x => !startArr.includes(x));\n    };\n\n    log('**********************************************');\n\n    /**\n     * get keys stored in sessionStorage.\n     * The init/success callback will add a new session key\n     * called 'zoomKeys' containig only the keys added by zoom.\n     *\n     * When the user logs out from moodle, the zoom_handler::loggedout\n     * php method will take care of deleting them, actually logging out\n     * the user from zoom.\n     */\n    const sessionKeys = getSessionKeys();\n\n    let language = userObj.lang || 'en-US';\n    if (-1 === language.indexOf('-')) {\n      language = language.toLowerCase() + '-' + (language !== 'en' ? language.toUpperCase() : 'US');\n    }\n\n    /**\n     * WARNING!!!\n     * Don't you dare removing https and starting the url with '//'.\n     * The lib is not going to work!\n     */\n    window.ZoomMtg.setZoomJSLib(`https://source.zoom.us/${zoomMeetingSdkWebVersion}/lib`, '/av');\n    window.ZoomMtg.preLoadWasm();\n\n    if ('function' == typeof window.ZoomMtg.prepareWebSDK) {\n      window.ZoomMtg.prepareWebSDK();\n    } else {\n      window.ZoomMtg.prepareJssdk();\n    }\n    // // loads language files, also passes any error messages to the ui\n    window.ZoomMtg.i18n.load(language);\n    window.ZoomMtg.i18n.reload(language);\n    // window.ZoomMtg.reRender({ lang: language });\n\n    startMeeting();\n\n    log('**********************************************');\n  };\n\n  // add event listeners\n  window.addEventListener(\"message\", (event) => {\n    if (window.self !== window.top) {\n      // messages handled inside the iframe\n      if (event.data.message === 'init') {\n        // trigger the init function\n        init(event.data.zoom, event.data.user, event.data.zoomSdkVersion, event.data.debugging);\n      }\n    } else {\n      // messages outside the iframe (i.e. in webmeeting.php)\n      if (event.data.message === 'zoomLeave') {\n        // zoomLeave, redirect to passed url\n        if ('redirect' in event.data) {\n          window.location.replace(event.data.redirect);\n        }\n      }\n    }\n  }, false);\n\n})();\n"],"names":["window","addEventListener","event","self","top","data","message","zoomObj","userObj","zoomMeetingSdkWebVersion","debugging","debug","log","LOG_PREFIX","Date","toLocaleString","args","Array","from","arguments","unshift","console","apply","error","getSessionKeys","retval","Object","keys","sessionStorage","forEach","key","push","getNewSessionKeys","startArr","filter","x","includes","sessionKeys","language","lang","inputStr","textarea","indexOf","toLowerCase","toUpperCase","ZoomMtg","setZoomJSLib","preLoadWasm","prepareWebSDK","prepareJssdk","i18n","load","reload","document","getElementById","style","display","getWebSDKVersion","checkFeatureRequirements","init","leaveUrl","createElement","innerHTML","value","disableCORP","crossOriginIsolated","enableHD","enableFullHD","isSupportAV","showMeetingHeader","userishost","videoHeader","isSupportBreakout","isSupportCC","isSupportChat","isSupportNonverbal","isSupportPolling","isSupportQA","disableCallOut","disableInvite","disableRecord","disableReport","meetingInfo","success","initResp","join","signature","sdkKey","meetingNumber","meeting_id","userName","fullname","userEmail","email","passWord","password","joinResp","getElementsByClassName","element","addedKeys","length","setItem","zoom","user","zoomSdkVersion","location","replace","redirect"],"mappings":"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"}